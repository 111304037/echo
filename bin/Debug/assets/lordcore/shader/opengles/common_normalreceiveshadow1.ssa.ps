#version 100

uniform mediump vec4 naturalColor;
uniform mediump vec4 LMUV;
uniform mediump vec3 LMScale;
uniform sampler2D texSampler;
uniform sampler2D LMSampler;
uniform sampler2D alphaSampler;
uniform sampler2D SMSampler;
uniform mediump float ShadowShade;

varying mediump vec4 ofogColor;
varying mediump vec2 texCoord;
varying mediump vec2 texCoord1;
varying mediump vec4 lightmapSpace;

void main(void)
{
	mediump vec4 alphaColor = texture2D(alphaSampler, texCoord);
	if(alphaColor.r < 0.5 )
        discard;

	mediump vec4 textureColor = texture2D(texSampler, texCoord);
	mediump vec3 LMColor = texture2D(LMSampler, texCoord1.xy*LMUV.zw+LMUV.xy).rgb* LMScale;
	
	// dynamic shadow
	mediump vec3  smCoordDepth = lightmapSpace.xyz / lightmapSpace.w; 
	mediump vec2  smCoord;
	smCoord = smCoordDepth.xy * 0.5 + 0.5;
	mediump float dxx;
	mediump float dx = 1.0;
	//if(smCoord.x >= 1.0 || smCoord.y>=1.0 || smCoord.x<=0.0 || smCoord.y<=0.0)
	// 	dx = 1.0;
	//else
	{
		mediump float z = clamp(smCoordDepth.z, 0.0, 1.0);
 		dxx = dot(vec4(texture2D(SMSampler, smCoord)) ,vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));
		dx = 2.71828 - exp((z-dxx)*1024.0);
	}
	
	mediump vec4 finalColor = vec4(textureColor.rgb * LMColor, alphaColor.r) + naturalColor;
	
	gl_FragColor = vec4(mix(ofogColor.xyz, finalColor.xyz, ofogColor.w), finalColor.w);
}